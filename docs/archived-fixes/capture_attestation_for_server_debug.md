# Capturing Attestation Data for Server Debugging

## Purpose

This guide helps you capture a real App Attest attestation from the iOS client to provide to the server team for debugging their validation logic.

## Quick Steps

### 1. Add Temporary Logging to NotificationManager

Open `Catbird/Features/Notifications/Services/NotificationManager.swift` and find the `prepareAppAttestPayload` function around line 1290.

**After this line:**
```swift
Successfully generated attestation, length: \(attestation?.count ?? 0)
```

**Add this temporary DEBUG logging:**
```swift
#if DEBUG
if let attestation = attestation {
  notificationLogger.info("=== ATTESTATION DEBUG DATA FOR SERVER ===")
  notificationLogger.info("ðŸ“‹ KeyID: \(keyIdentifier)")
  notificationLogger.info("ðŸ“‹ Challenge: \(challenge.challenge)")
  notificationLogger.info("ðŸ“‹ ClientData: \(clientDataString)")
  notificationLogger.info("ðŸ“‹ Attestation (first 500 chars): \(attestation.prefix(500))")
  notificationLogger.info("ðŸ“‹ Attestation length: \(attestation.count)")
  notificationLogger.info("ðŸ“‹ Bundle ID: \(Bundle.main.bundleIdentifier ?? "unknown")")
  notificationLogger.info("ðŸ“‹ DID: \(did)")
  notificationLogger.info("ðŸ“‹ Device Token: \(hexString(from: deviceToken))")
  notificationLogger.info("=== END ATTESTATION DEBUG DATA ===")
}
#endif
```

### 2. Build and Run on Physical Device

```bash
# Make sure you're in DEBUG configuration
# Build and run on your iPhone (NOT Simulator)
xcodebuild -scheme Catbird \
    -configuration Debug \
    -destination 'platform=iOS,id=YOUR_DEVICE_ID' \
    build
```

Or use Xcode: Product > Scheme > Edit Scheme > Run > Build Configuration > Debug

### 3. Enable Notifications

1. Launch app on device
2. Go to Settings > Notifications
3. Enable "Push Notifications"

### 4. Capture Console Output

**Option A: Use Console.app (Recommended)**
1. Open Console.app on your Mac
2. Connect your iPhone via USB
3. Select your device in sidebar
4. Filter by process: "Catbird"
5. Look for "=== ATTESTATION DEBUG DATA FOR SERVER ===" section
6. Copy all the data between the markers

**Option B: Use Xcode Console**
1. Run app from Xcode
2. Open Debug area (Cmd+Shift+Y)
3. Look for the debug data section
4. Copy the output

### 5. Format for Server Team

Create a file called `test_attestation.json`:

```json
{
  "test_case": "Catbird iOS Client - Real Attestation",
  "timestamp": "2025-01-XX XX:XX:XX",
  "device": "iPhone (iOS 26.0)",
  "bundle_id": "blue.catbird",
  "environment": "development",
  "data": {
    "key_id": "9AP/1nd1uuZo8pmqcvTSvHNYLwMGWEcbG7nFrrERfik=",
    "challenge": "92umsH1l5qTP3jDFO0nILqK9ZGZaQ01TvJAnYYdzdW4=",
    "client_data": "{\"challenge\":\"92umsH1l5qTP3jDFO0nILqK9ZGZaQ01TvJAnYYdzdW4=\"}",
    "attestation": "o2NmbXRvYXBwbGUtYXBwYXR0ZXN0Z2F0dFN0bXSiY3g1Y4...[FULL BASE64 STRING]...",
    "did": "did:plc:7nmnou7umkr46rp7u2hbd3nb",
    "device_token": "df1e2c3423e2860f..."
  },
  "notes": "This is a real attestation generated by Apple. Server should accept this if validation is working correctly."
}
```

### 6. Provide to Server Team

Send them:
1. The `test_attestation.json` file
2. A link to `SERVER_SIDE_APP_ATTEST_ISSUE.md`
3. Let them know this is a **real attestation from Apple** that should validate successfully

### 7. Server Team Can Test

The server team can use this data to:
1. Test their validation logic offline
2. Compare their validation with reference implementations
3. Debug certificate chain validation
4. Verify hash computations
5. Check signature verification

### 8. Remove Debug Logging

**IMPORTANT:** After you've captured the data, remove the temporary logging code!

```swift
#if DEBUG
// Remove this entire block
// if let attestation = attestation { ... }
#endif
```

Commit and push without the debug logging.

## What Server Should See

When server validates this attestation, it should:

âœ… **Extract certificate chain** from `x5c` field  
âœ… **Verify certificates** chain up to Apple's root CA  
âœ… **Check bundle ID** in certificate matches "blue.catbird"  
âœ… **Validate signature** on attestation object  
âœ… **Verify authenticatorData** format  
âœ… **Check clientDataHash** matches SHA256(clientData + requestBody)  
âœ… **Validate challenge** matches what server sent  
âœ… **Extract public key** and store for future assertion validation

If any of these steps fail, that's where the server bug is!

## Alternative: Use Network Proxy

If you want to capture the actual HTTP request:

### Using Charles Proxy or Proxyman

1. **Install Charles Proxy** or **Proxyman** on your Mac
2. **Configure iOS device** to use Mac as proxy
   - Settings > Wi-Fi > [Your Network] > HTTP Proxy
   - Server: Your Mac's IP address
   - Port: 8888 (Charles default)
3. **Trust Charles certificate** on iOS device
   - Charles Proxy > Help > SSL Proxying > Install Certificate on Mobile Device
4. **Enable SSL Proxying** for notifications.catbird.blue
5. **Trigger registration** in app
6. **View request** in Charles
7. **Export as cURL** or JSON

This captures the exact HTTP request the server receives, including all headers.

## Common Issues During Capture

### Issue: No Debug Output

**Problem:** You don't see the debug messages  
**Solution:** 
- Verify you're in DEBUG configuration
- Check Console.app is showing logs from your device
- Try filtering by "ATTESTATION DEBUG DATA"

### Issue: Attestation is null

**Problem:** Debug shows attestation is null  
**Solution:**
- This is expected on subsequent requests (only first uses attestation)
- Disable notifications, wait 30 seconds, re-enable to trigger fresh registration
- Or delete and reinstall app for guaranteed fresh registration

### Issue: Can't Copy from Console.app

**Problem:** Text is truncated or hard to copy  
**Solution:**
- Right-click on log message > "Copy Message"
- Or use Export to save all logs to file
- Or use `log stream --predicate 'process == "Catbird"'` in Terminal

## Summary

This captured data will help the server team debug their validation logic independently from the live app. Once they fix their validation to accept this real Apple-generated attestation, the integration will work!

**Remember:** Remove the debug logging after capturing the data. Don't commit it to the repository!
